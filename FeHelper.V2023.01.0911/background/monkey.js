import InjectTools from"./inject-tools.js";export default{start:t=>{try{const e="PAGE-MODIFIER-LOCAL-STORAGE-KEY";let r=e=>{e.filter(t=>!t.mDisabled).forEach(e=>{let r=null,n=e.mPattern.match(/^\/(.*)\/(.*)?$/);if(n&&(!n[2]||n[2]&&!/[^igm]*/i.test(n[2])))e.mPattern=new RegExp(n[1],n[2]||""),r=e.mPattern.test(t.url)&&e;else if(e.mPattern.indexOf("*")>-1)e.mPattern.startsWith("*://")?e.mPattern=e.mPattern.replace("*://","(http|https|file)://"):e.mPattern.indexOf("://")<0&&(e.mPattern="(http|https|file)://"+e.mPattern),e.mPattern=new RegExp("^"+e.mPattern.replace(/\./g,"\\.").replace(/\//g,"\\/").replace(/\*/g,".*").replace(/\?/g,"\\?")+"$"),r=e.mPattern.test(t.url)&&e;else{let n=[e.mPattern,`${e.mPattern}/`];e.mPattern.startsWith("http://")||e.mPattern.startsWith("https://")||(n=n.concat([`http://${e.mPattern}`,`http://${e.mPattern}/`,`https://${e.mPattern}`,`https://${e.mPattern}/`])),n.includes(t.url)&&(r=e)}if(r){let e="("+(t=>{let e=()=>{evalCore.getEvalInstance(window)(t.mScript),parseInt(t.mRefresh)&&setTimeout(()=>{location.reload(!0)},1e3*parseInt(t.mRefresh))};window._fhImportJs=(t=>fetch(t).then(t=>t.text()).then(t=>{if(window.evalCore&&window.evalCore.getEvalInstance)return window.evalCore.getEvalInstance(window)(t);let e=document.createElement("script");e.textContent=t,document.head.appendChild(e)}));let r=(t.mRequireJs||"").split(/[\s,ï¼Œ]+/).filter(t=>t.length);if(r.length){let t=Array.from(new Set(r)).map(t=>window._fhImportJs(t));Promise.all(t).then(e)}else e()}).toString()+`)(${JSON.stringify(r)})`;InjectTools.inject(t.tabId,{js:e,allFrames:!1})}})};chrome.storage.local.get(e,n=>{let a,l=!1;if(n&&n[e]?a=n[e]||"[]":(a=localStorage.getItem(e)||"[]",l=!0),t&&t.url&&r(JSON.parse(a)),l){let t={};t[e]=a,chrome.storage.local.set(t)}})}catch(t){console.log("monkey error",t)}return!0}};